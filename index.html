<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¨ã—ã‚¬ãƒãƒ£é‹è©¦ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ–</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #fffaf5;
    }
    table.layout-table td {
      padding: 5px 10px;
      vertical-align: middle;
    }
    .card-inputs input {
      width: 120px;
      margin: 3px;
    }
    .log, .summary {
      margin-top: 20px;
      white-space: pre-wrap;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
    }
    .collected {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px 10px;
    }
    th {
      background-color: #e0e0ff;
    }
  </style>
</head>
<body>
  <h1>æ¨ã—ã‚¬ãƒãƒ£é‹è©¦ã—ğŸ²</h1>
  <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ å°å…¥ã•ã‚ŒãŸæ¨ã—ã‚°ãƒƒã‚ºï¼ˆã‚«ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’å¼•ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ã€</p>
  <ul>
    <li>å®Ÿéš›ã«ã©ã‚Œãã‚‰ã„ã§ã‚³ãƒ³ãƒ—ã§ãã‚‹ã‹è©¦ã™</li>
    <li>ç†è«–å€¤ï¼ˆæœŸå¾…å€¤ï¼‰ã¨å®Ÿéš›ã®å·®ã‚’æ¥½ã—ã‚€</li>
    <li>æ²¼ã£ãŸã‹ã©ã†ã‹ã‚’æ•°å­—ã§å¯è¦–åŒ–ã™ã‚‹</li>
  </ul>
  <p>ã¨ã„ã£ãŸã“ã¨ãŒã§ãã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã®æšæ•°ã¯è‡ªç”±ã«å¤‰æ›´ãŒã§ãã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã«æ¨ã—ã®åå‰ã‚’å…¥ã‚Œã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
  <table class="layout-table">
    <tr>
      <td>ã‚«ãƒ¼ãƒ‰1æšã®ä¾¡æ ¼ï¼š</td>
      <td><input type="number" id="cardPrice" min="1" value="300"> å††</td>
    </tr>
    <tr>
      <td>ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã®æ•°ï¼š</td>
      <td><input type="number" id="cardCount" min="1" value="5"> æš <button onclick="generateInputs()">åç§°å…¥åŠ›æ¬„ã®æ•°ã‚’æ›´æ–°ã™ã‚‹</button></td>
    </tr>
    <tr>
      <td>ã‚«ãƒ¼ãƒ‰ã®åç§°ï¼š</td>
      <td><div class="card-inputs" id="cardInputs"></div></td>
    </tr>
  </table>

  <button onclick="drawCard()">å¼•ãï¼</button>
  <button onclick="resetResults()">çµæœã‚’ãƒªã‚»ãƒƒãƒˆ</button>

  <div class="log" id="drawLog"></div>
  <div class="collected" id="completionMessage"></div>
  <div class="summary" id="countSummary"></div>
  <div class="summary" id="expectationTable"></div>

  <script>
    let cardNames = [], drawnLog = [], collected = new Set(), countMap = {}, uniqueSteps = [];

    function generateInputs() {
      const count = parseInt(document.getElementById("cardCount").value);
      const container = document.getElementById("cardInputs");
      container.innerHTML = "";
      cardNames = [];
      drawnLog = [];
      collected.clear();
      countMap = {};
      uniqueSteps = [];
      document.getElementById("drawLog").textContent = "";
      document.getElementById("completionMessage").textContent = "";
      document.getElementById("countSummary").innerHTML = "";
      document.getElementById("expectationTable").innerHTML = "";

      for (let i = 0; i < count; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.value = `ã‚¿ã‚¤ãƒ—${i + 1}`;
        container.appendChild(input);
      }
    }

    function drawCard() {
      const inputs = document.querySelectorAll("#cardInputs input");
      if (inputs.length === 0) return;

      cardNames = Array.from(inputs).map(input => input.value.trim() || "(ç„¡å)");
      const index = Math.floor(Math.random() * cardNames.length);
      const drawn = cardNames[index];
      drawnLog.push(drawn);
      const isNew = !collected.has(drawn);
      if (isNew) uniqueSteps.push(drawnLog.length);
      collected.add(drawn);
      countMap[drawn] = (countMap[drawn] || 0) + 1;

      document.getElementById("drawLog").textContent += `ğŸ´ ${drawn} ã‚’å¼•ã„ãŸï¼ï¼ˆ${drawnLog.length}æšç›®ï¼‰\n`;

      if (collected.size === cardNames.length) {
        const price = parseInt(document.getElementById("cardPrice").value) || 0;
        const totalCost = price * drawnLog.length;
        document.getElementById("completionMessage").textContent =
          `âœ¨ ${drawnLog.length}æšã§ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ã¾ã—ãŸï¼ åˆè¨ˆ ${totalCost.toLocaleString()}å†† ğŸ’¸âœ¨`;
        showExpectationTable();
      }

      updateCountSummary();
    }

    function updateCountSummary() {
      let html = "<table><tr><th>åå‰</th><th>å‡ºãŸæšæ•°</th></tr>";
      for (const name of cardNames) {
        html += `<tr><td>${name}</td><td>${countMap[name] || 0}</td></tr>`;
      }
      html += "</table>";
      document.getElementById("countSummary").innerHTML = html;
    }

    function showExpectationTable() {
      const n = cardNames.length;
      let html = "<h3>ğŸ¯ æœŸå¾…å€¤ã¨ã®æ¯”è¼ƒ</h3>";
      html += "<table><tr><th>æšç›®ï¼ˆæ¨ã—ï¼‰</th><th>ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ããŸã‚ã«å¿…è¦ãªæšæ•°(ç†è«–å€¤)</th><th>å®Ÿéš›ã«å¼•ã„ãŸæšæ•°</th><th>æ²¼åˆ¤å®š</th><th>ç†è«–ä¸Šã®ç´¯ç©å¿…è¦æšæ•°</th><th>å®Ÿéš›ã®ç´¯ç©æšæ•°</th></tr>";
      let harmonicSum = 0;
      let actualCumulative = 0;
      for (let i = 1; i <= n; i++) {
        const name = cardNames[i - 1];
        const prob = (n - i + 1) / n;
        const expected = 1 / prob;
        harmonicSum += expected;
        const actual = uniqueSteps[i - 1] - (uniqueSteps[i - 2] || 0);
        actualCumulative += actual;
        const ratio = actual / expected;
        let comment = "â—‹";
        if (!(actual <= Math.ceil(expected) || ratio <= 1.3)) {
          if (ratio > 1.8) comment = "å¤§æ²¼ğŸ’¦";
          else comment = "ã¡ã‚‡ã„æ²¼";
        }

        html += `<tr><td>${i} (${name})</td><td>${expected.toFixed(2)}</td><td>${actual}</td><td>${comment}</td><td>${harmonicSum.toFixed(2)}</td><td>${actualCumulative}</td></tr>`;
      }
      const totalExpectedDraws = harmonicSum;
      const actualDraws = drawnLog.length;
      const price = parseInt(document.getElementById("cardPrice").value) || 0;
      const expectedCost = totalExpectedDraws * price;
      const actualCost = actualDraws * price;
      const diff = actualCost - expectedCost;

      html += `</table><p><strong>ğŸ§® ç†è«–ä¸Šã®å¿…è¦æšæ•°ï¼š</strong>${totalExpectedDraws.toFixed(2)}æšï¼ˆ${Math.round(expectedCost).toLocaleString()}å††ï¼‰</p>`;
      html += `<p><strong>ğŸ“¦ å®Ÿéš›ã«ã‹ã‹ã£ãŸæšæ•°ï¼š</strong>${actualDraws}æšï¼ˆ${actualCost.toLocaleString()}å††ï¼‰</p>`;
      html += `<p><strong>ğŸ’° å·®é¡ï¼š</strong>${diff >= 0 ? "ï¼‹" : "ï¼"}${Math.abs(Math.round(diff)).toLocaleString()}å††</p>`;

      document.getElementById("expectationTable").innerHTML = html;
    }

    function resetResults() {
      drawnLog = [];
      collected.clear();
      countMap = {};
      uniqueSteps = [];
      document.getElementById("drawLog").textContent = "";
      document.getElementById("completionMessage").textContent = "";
      document.getElementById("countSummary").innerHTML = "";
      document.getElementById("expectationTable").innerHTML = "";
    }

    generateInputs();
  </script>
</body>
</html>
